<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding RSVP Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap');
        .font-serif { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <script type="text/babel">
        const { useState } = React;

        // ================================
        // GOOGLE SHEETS API URL
        // ================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx3b1yWI5sMnd9r646scSYHW4-hGZv8rMfkXlKrF2MZ9EqlzHN_TYcq6R6loH1clvUi_w/exec';

        // ========================================
        // ADMIN PASSWORD - CHANGE THIS!
        // ========================================
        const ADMIN_PASSWORD = 'matiqueen2025';

        // ========================================
        // WEDDING SLOT TRACKING
        // ========================================
        const TOTAL_WEDDING_SLOTS = 45;
        const PRE_ALLOCATED_ATTENDEES = [
            { name: 'Delilah Malabanan', groupId: 'delilah-group' },
            { name: 'John Drew Malabanan', groupId: 'delilah-group' },
            { name: 'Fe Zamora', groupId: 'fe-group' },
            { name: 'Donato dela Luna', groupId: 'donato-group' },
            { name: 'Evelyn dela Luna', groupId: 'donato-group' },
            { name: 'Joshua Malabanan', groupId: 'joshua-group' },
            { name: 'Genel Malabanan', groupId: 'joshua-group' },
            { name: 'Roderick Malabanan', groupId: 'roderick-group' },
            { name: 'Ana Santos', groupId: 'ana-group' },
            { name: 'Mike Schultz', groupId: 'hannah-group' },
            { name: 'Hannah Olib-Schultz', groupId: 'hannah-group' },
            { name: 'Raul Mendejar', groupId: 'hannah2-group' },
            { name: 'Hannah Zamora-Mendejar', groupId: 'hannah2-group' },
            { name: 'Joseph Garibay', groupId: 'joseph-group' },
            { name: 'Jonathan de Belen', groupId: 'jonathan2-group' },
            { name: 'Lyra dela Luna', groupId: 'donato-group' },
            { name: 'Jonathan Roy Perilla', groupId: 'jonathan-group' },
            { name: 'Fatima dela Luna', groupId: 'dennis-group' },
            { name: 'Zany Jay Perilla', groupId: 'zany-group' },
            { name: 'Julia Arabela Malabanan', groupId: 'joshua-group' },
            { name: 'Maria Malabanan', groupId: 'maria-group' },
            { name: 'Victoria dela Luna', groupId: 'victoria-group' },
            { name: 'Naomi Perilla', groupId: 'naomi-group' }
        ];

        const isPreAllocated = (guestName, groupId) => {
            return PRE_ALLOCATED_ATTENDEES.some(
                attendee => attendee.name === guestName && attendee.groupId === groupId
            );
        };

        // Simple storage implementation (fallback)
        window.storage = {
            async get(key, shared = false) {
                const storageKey = shared ? `shared_${key}` : key;
                const data = localStorage.getItem(storageKey);
                return data ? { key, value: data, shared } : null;
            },
            async set(key, value, shared = false) {
                const storageKey = shared ? `shared_${key}` : key;
                localStorage.setItem(storageKey, value);
                return { key, value, shared };
            },
            async list(prefix, shared = false) {
                const keys = [];
                const storagePrefix = shared ? `shared_${prefix}` : prefix;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(storagePrefix)) {
                        keys.push(key);
                    }
                }
                return { keys, prefix, shared };
            }
        };

        // Icon components
        const Heart = ({ className }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
        );

        const Users = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 24 24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" fill="none" stroke="currentColor" strokeWidth={2} />
            </svg>
        );

        const XCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" strokeWidth={2} />
                <line x1="15" y1="9" x2="9" y2="15" strokeWidth={2} />
                <line x1="9" y1="9" x2="15" y2="15" strokeWidth={2} />
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="23 4 23 10 17 10" strokeWidth={2} />
                <polyline points="1 20 1 14 7 14" strokeWidth={2} />
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" strokeWidth={2} />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m14-7l-5 5m0 0l-5-5m5 5V3" />
            </svg>
        );

        const Calendar = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" strokeWidth={2} />
                <line x1="16" y1="2" x2="16" y2="6" strokeWidth={2} />
                <line x1="8" y1="2" x2="8" y2="6" strokeWidth={2} />
                <line x1="3" y1="10" x2="21" y2="10" strokeWidth={2} />
            </svg>
        );

        function AdminDashboard() {
            const [authenticated, setAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [rsvps, setRsvps] = useState([]);
            const [loading, setLoading] = useState(false);
            const [stats, setStats] = useState({ 
                total: 0, 
                attending: 0, 
                declined: 0, 
                weddingAndReception: 0,
                receptionOnly: 0,
                weddingSlotsUsed: 0
            });

            const handleLogin = () => {
                if (password === ADMIN_PASSWORD) {
                    setAuthenticated(true);
                    setError('');
                    loadRSVPs();
                } else {
                    setError('Invalid password');
                }
            };

            const loadRSVPs = async () => {
                setLoading(true);
                try {
                    // Try to fetch from Google Sheets first
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'GET',
                        redirect: 'follow'
                    });
                    
                    if (response.ok) {
                        const rsvpData = await response.json();
                        
                        // Handle if response is an error object
                        if (rsvpData.error) {
                            throw new Error(rsvpData.error);
                        }
                        
                        setRsvps(rsvpData);
                        
                        let attending = 0;
                        let declined = 0;
                        let totalGuests = 0;
                        let weddingAndReception = 0;
                        let receptionOnly = 0;
                        
                        rsvpData.forEach(rsvp => {
                            rsvp.guests.forEach(guest => {
                                totalGuests++;
                                if (guest.attending === true) {
                                    attending++;
                                    if (guest.attendanceType === 'both') {
                                        weddingAndReception++;
                                    } else if (guest.attendanceType === 'reception') {
                                        receptionOnly++;
                                    }
                                }
                                if (guest.attending === false) declined++;
                            });
                        });
                        
                        setStats({
                            total: totalGuests,
                            attending,
                            declined,
                            weddingAndReception,
                            receptionOnly,
                            weddingSlotsUsed: weddingAndReception
                        });
                        
                        setLoading(false);
                        return;
                    }
                } catch (err) {
                    console.log('Google Sheets unavailable, trying localStorage:', err);
                }
                
                // Fallback to localStorage if Google Sheets fails
                try {
                    const result = await window.storage.list('rsvp:', true);
                    
                    if (result && result.keys) {
                        const rsvpPromises = result.keys.map(async (key) => {
                            try {
                                const data = await window.storage.get(key, true);
                                return data ? JSON.parse(data.value) : null;
                            } catch (e) {
                                return null;
                            }
                        });
                        
                        const rsvpData = (await Promise.all(rsvpPromises)).filter(r => r !== null);
                        setRsvps(rsvpData);
                        
                        let attending = 0;
                        let declined = 0;
                        let totalGuests = 0;
                        let weddingAndReception = 0;
                        let receptionOnly = 0;
                        
                        rsvpData.forEach(rsvp => {
                            rsvp.guests.forEach(guest => {
                                totalGuests++;
                                if (guest.attending === true) {
                                    attending++;
                                    if (guest.attendanceType === 'both') {
                                        weddingAndReception++;
                                    } else if (guest.attendanceType === 'reception') {
                                        receptionOnly++;
                                    }
                                }
                                if (guest.attending === false) declined++;
                            });
                        });
                        
                        setStats({
                            total: totalGuests,
                            attending,
                            declined,
                            weddingAndReception,
                            receptionOnly,
                            weddingSlotsUsed: weddingAndReception
                        });
                    }
                } catch (err) {
                    console.error('Error loading RSVPs:', err);
                    setError('Error loading RSVPs');
                } finally {
                    setLoading(false);
                }
            };

            const exportToCSV = () => {
                let csv = 'Group ID,Password,Guest Name,Attending,Event Type,Pre-Allocated,Submitted At\n';
                
                rsvps.forEach(rsvp => {
                    rsvp.guests.forEach(guest => {
                        const attending = guest.attending === true ? 'Yes' : guest.attending === false ? 'No' : 'Pending';
                        const eventType = guest.attending === true 
                            ? (guest.attendanceType === 'both' ? 'Wedding & Reception' : 'Reception Only')
                            : 'N/A';
                        const preAllocated = guest.isPreAllocated ? 'Yes' : 'No';
                        csv += `"${rsvp.groupId}","${rsvp.password}","${guest.name}","${attending}","${eventType}","${preAllocated}","${new Date(rsvp.submittedAt).toLocaleString()}"\n`;
                    });
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wedding-rsvps-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            if (!authenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-amber-100 flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-lg shadow-2xl p-8">
                            <div className="text-center mb-8">
                                <Heart className="w-12 h-12 text-amber-600 mx-auto mb-4" />
                                <h1 className="text-3xl font-serif text-amber-900 mb-2">Admin Access</h1>
                                <p className="text-amber-700">Enter admin password to view RSVPs</p>
                            </div>
                            
                            <div>
                                <div className="mb-6">
                                    <label className="block text-amber-800 mb-2 font-medium">
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                        className="w-full px-4 py-3 border-2 border-amber-200 rounded-lg focus:outline-none focus:border-amber-400"
                                        placeholder="Enter admin password"
                                    />
                                </div>
                                
                                {error && (
                                    <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                        {error}
                                    </div>
                                )}
                                
                                <button
                                    onClick={handleLogin}
                                    className="w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg"
                                >
                                    Login
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const weddingSlotsRemaining = TOTAL_WEDDING_SLOTS - stats.weddingSlotsUsed;

            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-amber-100 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-2xl p-6 mb-6">
                            <div className="flex items-center justify-between mb-6 flex-wrap gap-4">
                                <div className="flex items-center gap-3">
                                    <Heart className="w-10 h-10 text-amber-600" />
                                    <div>
                                        <h1 className="text-3xl font-serif text-amber-900">RSVP Dashboard</h1>
                                        <p className="text-amber-700 text-sm">Wedding coordinator access</p>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={loadRSVPs}
                                        disabled={loading}
                                        className="flex items-center gap-2 px-4 py-2 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg transition"
                                    >
                                        <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
                                        Refresh
                                    </button>
                                    <button
                                        onClick={exportToCSV}
                                        className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition"
                                    >
                                        <Download className="w-4 h-4" />
                                        Export CSV
                                    </button>
                                </div>
                            </div>

                            {/* Stats Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <Users className="w-8 h-8 text-blue-600" />
                                        <div>
                                            <div className="text-2xl font-bold text-blue-900">{stats.total}</div>
                                            <div className="text-sm text-blue-700">Total Guests</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <CheckCircle className="w-8 h-8 text-green-600" />
                                        <div>
                                            <div className="text-2xl font-bold text-green-900">{stats.attending}</div>
                                            <div className="text-sm text-green-700">Total Attending</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <XCircle className="w-8 h-8 text-gray-600" />
                                        <div>
                                            <div className="text-2xl font-bold text-gray-900">{stats.declined}</div>
                                            <div className="text-sm text-gray-700">Declined</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <Calendar className="w-8 h-8 text-purple-600" />
                                        <div>
                                            <div className="text-2xl font-bold text-purple-900">{stats.weddingAndReception}</div>
                                            <div className="text-sm text-purple-700">Wedding & Reception</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-orange-50 border-2 border-orange-200 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <Heart className="w-8 h-8 text-orange-600" />
                                        <div>
                                            <div className="text-2xl font-bold text-orange-900">{stats.receptionOnly}</div>
                                            <div className="text-sm text-orange-700">Reception Only</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-amber-50 border-2 border-amber-200 rounded-lg p-4">
                                    <div className="flex items-center gap-3">
                                        <Users className="w-8 h-8 text-amber-600" />
                                        <div>
                                            <div className="text-2xl font-bold text-amber-900">{rsvps.length}</div>
                                            <div className="text-sm text-amber-700">Groups Responded</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Wedding Slots Status */}
                            <div className="bg-gradient-to-r from-rose-50 to-pink-50 border-2 border-rose-200 rounded-lg p-6">
                                <div className="flex items-center justify-between flex-wrap gap-4">
                                    <div>
                                        <h3 className="text-lg font-semibold text-rose-900 mb-1">Wedding Ceremony Capacity</h3>
                                        <p className="text-sm text-rose-700">
                                            {PRE_ALLOCATED_ATTENDEES.length} pre-allocated spots + {TOTAL_WEDDING_SLOTS - PRE_ALLOCATED_ATTENDEES.length} available spots
                                        </p>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-4xl font-bold text-rose-900">{stats.weddingSlotsUsed} / {TOTAL_WEDDING_SLOTS}</div>
                                        <div className="text-sm text-rose-700 font-medium">
                                            {weddingSlotsRemaining} slot{weddingSlotsRemaining !== 1 ? 's' : ''} remaining
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-4 bg-white rounded-full h-4 overflow-hidden">
                                    <div 
                                        className="h-full bg-gradient-to-r from-rose-500 to-pink-500 transition-all duration-500"
                                        style={{ width: `${(stats.weddingSlotsUsed / TOTAL_WEDDING_SLOTS) * 100}%` }}
                                    ></div>
                                </div>
                            </div>
                        </div>

                        {/* RSVP List */}
                        <div className="bg-white rounded-lg shadow-2xl overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-amber-100 border-b-2 border-amber-200">
                                        <tr>
                                            <th className="px-6 py-4 text-left text-sm font-semibold text-amber-900">Group</th>
                                            <th className="px-6 py-4 text-left text-sm font-semibold text-amber-900">Password</th>
                                            <th className="px-6 py-4 text-left text-sm font-semibold text-amber-900">Guests</th>
                                            <th className="px-6 py-4 text-left text-sm font-semibold text-amber-900">Submitted</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-amber-100">
                                        {rsvps.length === 0 ? (
                                            <tr>
                                                <td colSpan="4" className="px-6 py-8 text-center text-amber-600">
                                                    {loading ? 'Loading RSVPs...' : 'No RSVPs yet'}
                                                </td>
                                            </tr>
                                        ) : (
                                            rsvps.map((rsvp, idx) => (
                                                <tr key={idx} className="hover:bg-amber-50">
                                                    <td className="px-6 py-4">
                                                        <div className="font-medium text-amber-900">{rsvp.groupId}</div>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <div className="text-sm text-amber-700 font-mono bg-amber-50 px-2 py-1 rounded inline-block">
                                                            {rsvp.password}
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <div className="space-y-2">
                                                            {rsvp.guests.map((guest, gIdx) => (
                                                                <div key={gIdx} className="flex items-center gap-2 flex-wrap">
                                                                    {guest.attending === true && (
                                                                        <CheckCircle className="w-4 h-4 text-green-600 flex-shrink-0" />
                                                                    )}
                                                                    {guest.attending === false && (
                                                                        <XCircle className="w-4 h-4 text-gray-500 flex-shrink-0" />
                                                                    )}
                                                                    <span className="text-sm text-amber-900 font-medium">{guest.name}</span>
                                                                    <span className={`text-xs px-2 py-0.5 rounded ${
                                                                        guest.attending === true 
                                                                            ? 'bg-green-100 text-green-700' 
                                                                            : guest.attending === false 
                                                                            ? 'bg-gray-100 text-gray-700'
                                                                            : 'bg-amber-100 text-amber-700'
                                                                    }`}>
                                                                        {guest.attending === true ? 'Attending' : guest.attending === false ? 'Declined' : 'Pending'}
                                                                    </span>
                                                                    {guest.attending === true && (
                                                                        <span className={`text-xs px-2 py-0.5 rounded font-medium ${
                                                                            guest.attendanceType === 'both'
                                                                                ? 'bg-purple-100 text-purple-700'
                                                                                : 'bg-orange-100 text-orange-700'
                                                                        }`}>
                                                                            {guest.attendanceType === 'both' ? 'Wedding & Reception' : 'Reception Only'}
                                                                        </span>
                                                                    )}
                                                                    {guest.isPreAllocated && (
                                                                        <span className="text-xs px-2 py-0.5 rounded bg-rose-100 text-rose-700 font-medium">
                                                                            ‚≠ê Reserved
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 text-sm text-amber-700">
                                                        {new Date(rsvp.submittedAt).toLocaleString()}
                                                    </td>
                                                </tr>
                                            ))
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<AdminDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
